<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mes serveurs ‚Äî Project : Delta</title>
  <link rel="icon" href="/assets/delta-icon.png" type="image/png" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .grayscale {
      filter: grayscale(100%);
      opacity: 0.5;
    }
  </style>
  <script defer src="serveurs.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen">

  <!-- Navigation -->
  <nav class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex items-center justify-between fixed top-0 left-0 right-0 z-40 shadow-md">
    <div class="text-2xl font-bold text-indigo-400 animate-pulse">Project : Delta</div>
    <ul class="hidden md:flex space-x-6 text-sm font-medium text-gray-300">
      <li><a href="/" class="hover:text-indigo-400 transition">Accueil</a></li>
      <li><a href="/dashboard.html" class="hover:text-indigo-400 transition">Dashboard</a></li>
      <li><a href="/support.html" class="hover:text-indigo-400 transition">Support</a></li>
    </ul>
  </nav>

  <!-- Contenu principal -->
  <main class="pt-32 px-6 pb-12 max-w-6xl mx-auto">
    <h1 class="text-4xl font-extrabold mb-10 text-center text-indigo-300">Vos serveurs</h1>
    <div id="user-info" class="text-center mb-8"></div>
    <div id="guilds" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></div>
  </main>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const returnedState = urlParams.get("state");
    const savedState = localStorage.getItem("oauth2_state");

    async function afficherInfosUtilisateur(user) {
      const container = document.getElementById("user-info");
      const avatarURL = user.avatar
        ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
        : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator) % 5}.png`;

      container.innerHTML = `
        <div class="flex items-center justify-center gap-4">
          <img src="${avatarURL}" alt="Avatar" class="w-16 h-16 rounded-full">
          <p class="text-lg">Connect√© en tant que <strong>${user.username}#${user.discriminator}</strong></p>
        </div>
      `;
    }

    async function afficherGuilds(guilds) {
      const container = document.getElementById("guilds");
      if (!guilds.length) {
        container.innerHTML = "<p>Aucun serveur mutualis√© trouv√©.</p>";
        return;
      }

      guilds.forEach(g => {
        const div = document.createElement("div");
        div.className = "bg-gray-800 p-4 rounded-lg shadow-md hover:shadow-xl transition";
        div.innerHTML = `
          <img src="${g.icon || 'https://cdn.discordapp.com/embed/avatars/0.png'}" alt="Icon" class="w-16 h-16 rounded mx-auto mb-4">
          <h3 class="text-xl font-semibold text-center">${g.name}</h3>
          <p class="text-center text-gray-400">Membres : ${g.memberCount}</p>
          ${g.isOwner ? '<p class="text-center text-yellow-400 mt-2">üëë Owner</p>' : ''}
        `;
        container.appendChild(div);
      });
    }

    async function start() {
      const container = document.getElementById("user-info");
      container.innerHTML = `<p>Chargement...</p>`;

      if (code && returnedState === savedState) {
        try {
          const response = await fetch(`https://discord-oauth-6z2s.onrender.com/api/discord-oauth?code=${code}`);
          const data = await response.json();

          if (data.success) {
            localStorage.setItem("user", JSON.stringify(data.user));
            localStorage.removeItem("oauth2_state");
            window.history.replaceState({}, "", "serveur.html");
            await afficherInfosUtilisateur(data.user);
            await afficherGuilds(data.mutualGuilds);
          } else {
            container.innerHTML = `<p>Erreur d'authentification : ${data.error}</p>`;
          }
        } catch (err) {
          container.innerHTML = `<p>Erreur lors de la requ√™te.</p>`;
        }
      } else {
        if (code && returnedState !== savedState) {
          alert("√âtat de s√©curit√© invalide, possible tentative d'injection !");
          return;
        }

        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          await afficherInfosUtilisateur(user);
        } else {
          container.innerHTML = `<p>Non connect√©. <a href="/" class="text-indigo-400 underline">Retour</a></p>`;
        }
      }
    }

    start();
  </script>

</body>
</html>
